---
# ML Lab Configuration
# Hyperparameters and settings for machine learning optimization

# Phase 1: Data Collection
data_collection:
  start_date: "2022-01-01"
  end_date: "2025-11-30"
  forward_days: [2, 3, 4]  # Calculate returns for these holding periods (added 3-day for trajectory analysis)
  checkpoint_frequency: 30  # Save checkpoint every N days (optimized for speed vs safety)
  max_workers: 2  # Parallel processing (2x speedup, very stable)

# Phase 2: Factor Analysis
factor_analysis:
  min_samples: 10000  # Minimum samples required
  ic_threshold: 0.05  # Information Coefficient significance threshold
  correlation_threshold: 0.8  # Remove factors with correlation above this
  
  # COMPREHENSIVE FEATURE LIST (63 features total)
  # Updated 2025-12-11: Added 9 new divergence features, removed 4 broken features
  # Updated 2025-12-11: Added 6 dividend/MA/oscillator features
  # Updated 2025-12-11: Training period extended to 2022-01-01 to 2025-11-30 (4 years)
  
  factors_to_test:
    # === INSTITUTIONAL FLOW METRICS (Core Signals) ===
    - Flow_Velocity_Rank          # Cross-stock ranking of flow acceleration (HIGH PRIORITY)
    - Flow_Rank                    # Cross-stock ranking of current flow strength (HIGH PRIORITY)
    - Flow_Percentile              # Historical percentile of flow for this stock (HIGH PRIORITY)
    - Flow_Velocity_Percentile     # Historical percentile of flow velocity (MEDIUM-HIGH)
    - Volume_Conviction            # Ratio of up-day to down-day volume (CRITICAL)
    - Volume_Conviction_Rank       # Cross-stock ranking of conviction (HIGH)
    - Conviction_Velocity          # Rate of change in conviction (MEDIUM-HIGH)
    
    # === THREE-INDICATOR SYSTEM (Percentiles) ===
    - MPI_Percentile               # Money flow position percentile (MEDIUM-HIGH)
    - IBS_Percentile               # Internal bar strength percentile (MEDIUM)
    - VPI_Percentile               # Volume positivity index percentile (LOW-MEDIUM)
    
    # === DIVERGENCE FEATURES (NEW - Fixed Math) ===
    # Type 1: Price-Flow Misalignment (Mean Reversion)
    - Flow_Price_Gap               # Price pct - Flow pct (-100 to +100) (HIGH)
    - Gap_Severity                 # Absolute magnitude of gap (0-100) (HIGH)
    - Is_Flow_Misaligned           # Binary: Significant misalignment (MEDIUM-HIGH)
    
    # Type 2: Classical Divergence (Momentum Exhaustion)
    - Bullish_Divergence           # Binary: Price down + Flow up (HIGH)
    - Bearish_Divergence           # Binary: Price up + Flow down (HIGH)
    - Divergence_Strength          # Magnitude of slope difference (0-100) (MEDIUM-HIGH)
    - Divergence_Duration          # Days since divergence started (MEDIUM)
    
    # Type 3: Volume-Price Divergence (Quality Signals)
    - Is_Volume_Weak               # Binary: Strong price + weak volume (MEDIUM-HIGH)
    - Volume_Price_Alignment       # Correlation score (0-100) (MEDIUM)
    
    # === SIGNAL & PATTERN FEATURES ===
    - Signal_Bias                  # Categorical: BULLISH/BEARISH/NEUTRAL (HIGH)
    - Conviction_Level             # Categorical: High/Moderate/Low (HIGH)
    - Is_Triple_Aligned            # Binary: All 3 indicators aligned (HIGH)
    - Is_Accumulation              # Binary: Accumulation pattern (MEDIUM)
    - HL_Pattern                   # Categorical: HHL/HH/LHL/LL/- (MEDIUM)
    
    # === ACCELERATION METRICS ===
    - IBS_Accel                    # 2nd derivative of IBS (MEDIUM)
    - RVol_Accel                   # 2nd derivative of relative volume (MEDIUM-HIGH)
    - RRange_Accel                 # 2nd derivative of relative range (MEDIUM)
    - VPI_Accel                    # 2nd derivative of VPI (LOW)
    
    # === VOLUME METRICS ===
    - Relative_Volume              # Current volume / 14-day avg (HIGH)
    - RelVol_Velocity              # Rate of change in relative volume (MEDIUM-HIGH)
    - VPI_Velocity                 # Rate of change in VPI (LOW)
    
    # === VOLATILITY/RANGE METRICS ===
    - VW_Range_Velocity            # Rate of change in volume-weighted range (MEDIUM)
    - VW_Range_Percentile          # Historical percentile of VW range (MEDIUM)
    - Rel_Range_Signal             # Range signal strength (LOW)
    
    # === MPI CONTEXT ===
    - MPI_Velocity                 # Rate of change in MPI (MEDIUM-HIGH)
    - MPI_Zone                     # Zone classification 1-5 (MEDIUM)
    
    # === PRICE ACTION (Binary Flags) ===
    - Higher_H                     # Made higher high (LOW-MEDIUM)
    - Higher_HL                    # Made higher high AND low (LOW-MEDIUM)
    - Lower_L                      # Made lower low (LOW-MEDIUM)
    - Lower_HL                     # Made lower high AND low (LOW-MEDIUM)
    
    # === ADDITIONAL FLOW METRICS ===
    - Flow_10D                     # 10-day cumulative flow (MEDIUM)
    - Price_Percentile             # Historical price percentile (MEDIUM-HIGH)

# Phase 3: Model Training
model_training:
  test_size: 0.2
  random_state: 42
  cv_folds: 5

  # Linear Models
  linear:
    alpha_range: [0.001, 0.01, 0.1, 1.0, 10.0]

  # Random Forest
  random_forest:
    n_estimators: [100, 200, 300]
    max_depth: [10, 20, None]
    min_samples_split: [2, 5, 10]
    min_samples_leaf: [1, 2, 4]

  # XGBoost
  xgboost:
    max_depth: [3, 5, 7]
    learning_rate: [0.01, 0.05, 0.1]
    n_estimators: [100, 200, 300]
    subsample: [0.8, 1.0]
    colsample_bytree: [0.8, 1.0]

# Phase 4: Validation
validation:
  walk_forward_window: 252  # 1 year rolling window
  step_size: 20  # Move forward 20 days each step
  min_periods: 100  # Minimum samples per validation fold

# Phase 5: Deployment
deployment:
  model_registry_path: "models/production/"
  backup_old_models: true
  a_b_test_duration: 30  # Days to run A/B test
  confidence_threshold: 0.95  # Statistical significance level

# General Settings
general:
  random_seed: 42
  log_level: "INFO"
  cache_enabled: true
  parallel_processing: false  # Keep simple for now

# Performance Monitoring
monitoring:
  track_metrics:
    - ic_mean
    - ic_std
    - sharpe_ratio
    - max_drawdown
    - win_rate
    - profit_factor
  alert_thresholds:
    ic_drop: 0.1  # Alert if IC drops by 10%
    sharpe_drop: 0.5  # Alert if Sharpe drops by 0.5
